# Internationalization (i18n)

This document describes how internationalization is implemented in Terminal.FM and how to contribute translations.

## Table of Contents

- [Overview](#overview)
- [Supported Languages](#supported-languages)
- [Architecture](#architecture)
- [Adding a New Language](#adding-a-new-language)
- [Translation File Format](#translation-file-format)
- [Using Translations in Code](#using-translations-in-code)
- [Testing Translations](#testing-translations)
- [Translation Guidelines](#translation-guidelines)

## Overview

Terminal.FM uses [go-i18n](https://github.com/nicksnyder/go-i18n) for internationalization. This library:
- Supports pluralization
- Handles message formatting with variables
- Provides compile-time type safety
- Works with TOML translation files

## Supported Languages

### Current (v1.0)
- **English** (en-US) - Default
- **Italian** (it-IT)

### Planned
- Spanish (es-ES)
- French (fr-FR)
- German (de-DE)
- Portuguese (pt-BR)
- Japanese (ja-JP)

Want to add your language? See [Contributing Translations](#adding-a-new-language).

## Architecture

### Directory Structure

```
terminal-fm/
├── pkg/i18n/
│   ├── i18n.go              # i18n initialization
│   ├── bundle.go            # Message bundle management
│   └── locales/
│       ├── active.en.toml   # English translations
│       ├── active.it.toml   # Italian translations
│       └── translate.*.toml # Translation templates (generated)
```

### How It Works

```
┌─────────────┐
│ User Session│
│ (SSH conn)  │
└──────┬──────┘
       │
       ▼
┌──────────────────┐
│ Detect Language  │
│ (from prefs or   │
│  env LANG)       │
└────────┬─────────┘
         │
         ▼
┌────────────────────┐
│ Load Message Bundle│
│ for User Language  │
└────────┬───────────┘
         │
         ▼
┌────────────────────┐
│ Render UI with     │
│ Localized Messages │
└────────────────────┘
```

## Adding a New Language

### Step 1: Create Translation File

```bash
# Copy English template
cd pkg/i18n/locales
cp active.en.toml active.{LOCALE}.toml

# Example for Spanish:
cp active.en.toml active.es.toml
```

### Step 2: Translate Strings

Edit `active.{LOCALE}.toml` and translate all strings. Keep the message IDs (keys) unchanged, translate only the values.

**Example** (`active.es.toml`):
```toml
# Welcome messages
[welcome.title]
description = "Welcome message shown on startup"
other = "¡Bienvenido a Terminal.FM!"

[welcome.subtitle]
description = "Subtitle with station count"
other = "Escucha más de {{.Count}} estaciones de radio"

# Navigation
[nav.up]
description = "Navigate up instruction"
other = "↑/k: Arriba"

[nav.down]
description = "Navigate down instruction"
other = "↓/j: Abajo"
```

### Step 3: Register Language

Edit `pkg/i18n/i18n.go`:

```go
var supportedLanguages = []string{
    "en-US",
    "it-IT",
    "es-ES", // Your new language
}

var languageNames = map[string]string{
    "en-US": "English",
    "it-IT": "Italiano",
    "es-ES": "Español", // Your new language
}
```

### Step 4: Test

```bash
# Run with your language
LANG=es_ES go run ./cmd/server --dev

# Or test from code
ssh localhost -p 2222
# Then switch language in settings menu
```

### Step 5: Submit Pull Request

```bash
git checkout -b feat/i18n-spanish
git add pkg/i18n/locales/active.es.toml pkg/i18n/i18n.go
git commit -m "feat(i18n): add Spanish translation"
git push origin feat/i18n-spanish
```

See [CONTRIBUTING.md](../CONTRIBUTING.md) for PR guidelines.

## Translation File Format

### Basic Message

```toml
[message.id]
description = "Context for translators"
other = "Translated text"
```

### Message with Variables

```toml
[station.playing]
description = "Shows currently playing station"
other = "Now playing: {{.StationName}}"
```

### Pluralization

```toml
[station.count]
description = "Number of stations"
one = "{{.Count}} station"
other = "{{.Count}} stations"
```

### Multiple Plural Forms

Some languages have complex plural rules. go-i18n handles this automatically.

**English** (2 forms):
```toml
[file.count]
one = "{{.Count}} file"
other = "{{.Count}} files"
```

**Italian** (2 forms):
```toml
[file.count]
one = "{{.Count}} file"
other = "{{.Count}} file"
```

**Russian** (3 forms):
```toml
[file.count]
one = "{{.Count}} файл"
few = "{{.Count}} файла"
other = "{{.Count}} файлов"
```

## Using Translations in Code

### Initialize Bundle

```go
package i18n

import (
    "embed"
    "github.com/nicksnyder/go-i18n/v2/i18n"
    "golang.org/x/text/language"
    "gopkg.in/yaml.v2"
)

//go:embed locales/*.toml
var localeFS embed.FS

var bundle *i18n.Bundle

func Init() error {
    bundle = i18n.NewBundle(language.English)
    bundle.RegisterUnmarshalFunc("toml", toml.Unmarshal)

    // Load all locale files
    files, err := localeFS.ReadDir("locales")
    if err != nil {
        return err
    }

    for _, file := range files {
        if filepath.Ext(file.Name()) == ".toml" {
            bundle.LoadMessageFileFS(localeFS, "locales/"+file.Name())
        }
    }

    return nil
}
```

### Create Localizer

```go
// For each user session
func NewLocalizer(lang string) *i18n.Localizer {
    return i18n.NewLocalizer(bundle, lang, "en-US")
}
```

### Translate Messages

#### Simple Message

```go
func (m *Model) RenderWelcome() string {
    msg := m.localizer.MustLocalize(&i18n.LocalizeConfig{
        MessageID: "welcome.title",
    })
    return msg
}
```

#### Message with Variables

```go
func (m *Model) RenderStationInfo(name string, bitrate int) string {
    msg := m.localizer.MustLocalize(&i18n.LocalizeConfig{
        MessageID: "station.info",
        TemplateData: map[string]interface{}{
            "Name":    name,
            "Bitrate": bitrate,
        },
    })
    return msg
}
```

#### Message with Pluralization

```go
func (m *Model) RenderStationCount(count int) string {
    msg := m.localizer.MustLocalize(&i18n.LocalizeConfig{
        MessageID: "station.count",
        PluralCount: count,
        TemplateData: map[string]interface{}{
            "Count": count,
        },
    })
    return msg
}
```

#### With Fallback

```go
func (m *Model) Translate(id string) string {
    msg, err := m.localizer.Localize(&i18n.LocalizeConfig{
        MessageID: id,
        DefaultMessage: &i18n.Message{
            ID: id,
            Other: id, // Fallback to message ID
        },
    })
    if err != nil {
        return id
    }
    return msg
}
```

### Detect User Language

```go
func DetectLanguage(session ssh.Session) string {
    // 1. Check user preferences (stored in DB)
    if userLang := getUserPreferredLanguage(session); userLang != "" {
        return userLang
    }

    // 2. Check SSH environment variable
    env := session.Environ()
    for _, e := range env {
        if strings.HasPrefix(e, "LANG=") {
            lang := strings.TrimPrefix(e, "LANG=")
            // Convert "en_US.UTF-8" to "en-US"
            return normalizeLocale(lang)
        }
    }

    // 3. Default to English
    return "en-US"
}

func normalizeLocale(locale string) string {
    // "en_US.UTF-8" -> "en-US"
    locale = strings.Split(locale, ".")[0]
    locale = strings.ReplaceAll(locale, "_", "-")
    return locale
}
```

## Testing Translations

### Unit Tests

```go
func TestTranslations(t *testing.T) {
    if err := i18n.Init(); err != nil {
        t.Fatalf("Failed to initialize i18n: %v", err)
    }

    tests := []struct {
        lang      string
        messageID string
        want      string
    }{
        {"en-US", "welcome.title", "Welcome to Terminal.FM!"},
        {"it-IT", "welcome.title", "Benvenuto su Terminal.FM!"},
        {"es-ES", "welcome.title", "¡Bienvenido a Terminal.FM!"},
    }

    for _, tt := range tests {
        t.Run(tt.lang+"_"+tt.messageID, func(t *testing.T) {
            localizer := i18n.NewLocalizer(tt.lang)
            got := localizer.MustLocalize(&i18n.LocalizeConfig{
                MessageID: tt.messageID,
            })
            if got != tt.want {
                t.Errorf("got %q, want %q", got, tt.want)
            }
        })
    }
}
```

### Manual Testing

```bash
# Test English
LANG=en_US go run ./cmd/server --dev
ssh localhost -p 2222

# Test Italian
LANG=it_IT go run ./cmd/server --dev
ssh localhost -p 2222

# Test Spanish
LANG=es_ES go run ./cmd/server --dev
ssh localhost -p 2222
```

### Verify All Keys Exist

```bash
# Script to check missing translations
#!/bin/bash
BASE_LANG="en"
CHECK_LANG="it"

BASE_KEYS=$(grep "^\[" pkg/i18n/locales/active.$BASE_LANG.toml | sort)
CHECK_KEYS=$(grep "^\[" pkg/i18n/locales/active.$CHECK_LANG.toml | sort)

echo "Missing keys in $CHECK_LANG:"
comm -23 <(echo "$BASE_KEYS") <(echo "$CHECK_KEYS")
```

## Translation Guidelines

### General Rules

1. **Context Matters**: Read the `description` field to understand context
2. **Consistency**: Use consistent terminology throughout
3. **Preserve Formatting**: Keep placeholders like `{{.Variable}}`
4. **Length Awareness**: Translations may be longer; consider UI space
5. **Cultural Sensitivity**: Adapt idioms appropriately
6. **Tone**: Keep the friendly, welcoming tone

### Placeholders

Never translate variable names inside `{{ }}`:

```toml
# ✓ Good
other = "Riproducendo: {{.StationName}}"

# ✗ Bad
other = "Riproducendo: {{.NomeStazione}}"
```

### Keyboard Shortcuts

Keep keyboard shortcuts in original form:

```toml
# ✓ Good
other = "↑/k: Su  ↓/j: Giù"

# ✗ Bad (translating shortcut keys)
other = "↑/a: Su  ↓/b: Giù"
```

### Technical Terms

Some terms should not be translated:

- **Bitrate**: bitrate (not "velocità di bit")
- **Codec**: codec (not "codificatore")
- **SSH**: SSH (acronym)
- **URL**: URL (acronym)
- **API**: API (acronym)

### Example Translation Quality

**Good**:
```toml
[player.error.connection]
description = "Error shown when station fails to connect"
other = "Impossibile connettersi alla stazione. Verifica la tua connessione."
```

**Bad** (machine translation):
```toml
[player.error.connection]
description = "Error shown when station fails to connect"
other = "Non può connettere stazione. Controlla connessione."
# Issues: Awkward phrasing, missing articles
```

### Pluralization

Check your language's plural rules on [Unicode CLDR](https://cldr.unicode.org/index/cldr-spec/plural-rules).

**English** (2 forms):
- one: n == 1
- other: everything else

**Italian** (2 forms):
- one: n == 1
- other: everything else

**French** (2 forms):
- one: n == 0 or n == 1
- other: everything else

**Polish** (3 forms):
- one: n == 1
- few: n % 10 in [2, 3, 4] and n % 100 not in [12, 13, 14]
- other: everything else

## Checklist for New Translation

- [ ] Copy `active.en.toml` to `active.{LOCALE}.toml`
- [ ] Translate all message strings
- [ ] Preserve all placeholders (`{{.Variable}}`)
- [ ] Handle pluralization correctly
- [ ] Keep keyboard shortcuts unchanged
- [ ] Add language to `supportedLanguages` in `i18n.go`
- [ ] Add language name to `languageNames` in `i18n.go`
- [ ] Test with `LANG={LOCALE}` environment variable
- [ ] Test in settings menu language switcher
- [ ] Verify UI doesn't break with longer translations
- [ ] Submit PR with descriptive title

## Common Messages Reference

### UI Elements

```toml
[ui.loading]
other = "Loading..."

[ui.error]
other = "Error"

[ui.search.placeholder]
other = "Search stations..."

[ui.menu.file]
other = "File"

[ui.menu.help]
other = "Help"
```

### Player Controls

```toml
[player.play]
other = "Play"

[player.pause]
other = "Pause"

[player.stop]
other = "Stop"

[player.volume]
other = "Volume: {{.Level}}%"
```

### Station Browser

```toml
[browser.title]
other = "Browse Stations"

[browser.filter.country]
other = "Country: {{.Country}}"

[browser.filter.genre]
other = "Genre: {{.Genre}}"

[browser.station.count]
one = "{{.Count}} station found"
other = "{{.Count}} stations found"
```

---

For contributing guidelines, see [../CONTRIBUTING.md](../CONTRIBUTING.md).

For architecture details, see [../ARCHITECTURE.md](../ARCHITECTURE.md).
